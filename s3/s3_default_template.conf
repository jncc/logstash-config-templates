input {
  s3 {
    "bucket" => "${S3_LOG_BUCKET}"
    "region" => "${S3_REGION}"
    "prefix" => "${S3_PREFIX}"
    "sincedb_path" => "${SINCEDB_PATH}"
    "temporary_directory" => "${S3_TMP_DIRECTORY}"
  }
}

filter {
  grok {
    match => { "message" => "%{S3_ACCESS_LOG}"}
  }
  mutate {
    rename => {
      "request" => "[request][original]"
      "clientip" => "[request][ip]"
      "key" => "[request][path]"
      "verb" => "[request][verb]"
      "httpversion" => "[request][http_version]"
      "bucket" => "[request][s3][bucket]"
      "owner" => "[request][s3][owner]"
      "requester" => "[request][s3][requester]"
      "request_id" => "[request][s3][request_id]"
      "operation" => "[request][s3][operation]"
    }
  }
  if [response] {
    mutate {
      rename => {
        "response" => "[response][status]"
      }
	}
  }
  if [error_code] {
    mutate {
      rename => {
        "error_code" => "[response][s3][error_code]"
      }
    }
  }
  if [bytes] {
    mutate {
      rename => {
        "bytes" => "[response][size]"
      }
      convert => {
        "[response][size]" => "integer"
      }
    }
  }
  if [object_size] {
    mutate {
      rename => {
        "object_size" => "[s3][object_size]"
      }
      convert => {
        "[s3][object_size]" => "integer"
      }
	}
  }
  if [request_time_ms] {
    mutate {
      rename => {
        "request_time_ms" => "[response][time]"
      }
      convert => {
        "[response][time]" => "integer"
      }
	}
  }
  if [turnaround_time_ms] {
    mutate {
      rename => {
        "turnaround_time_ms" => "[s3][turnaround_time_ms]"
      }
      convert => {
        "[response][s3][turnaround_time_ms]" => "integer"
      }
    }
  }
  if [referrer] {
    mutate {
      rename => {
        "referrer" => "[request][referrer]"
      }
      gsub => [
        "[request][referrer]", '"', ""
      ]
    }
  }
  if [agent] {
    mutate {
      rename => {
        "agent" => "[request][user_agent]"
      }
      gsub => [
        "[request][user_agent]", '"', ""
        ]
      }
  }
  if [version_id] {
    mutate {
      rename => {
        "version_id" => "[request][s3][version_id]"  
      }
    }
  }
  geoip {
    source => "[request][ip]"
    target => "[request][geoip]"
    database => "${GEOIP_DATABASE_PATH}"
    add_field => [ "[request][geoip][coordinates]", "%{[request][geoip][longitude]}" ]
    add_field => [ "[request][geoip][coordinates]", "%{[request][geoip][latitude]}"  ]
  }
  mutate {
    convert => {
      "[request][geoip][coordinates]" => "float"
    }
  }
  date {
    locale => "en"
    match => ["timestamp", "d/MMM/YYYY:HH:mm:ss Z"]
  }
}

output {
  elasticsearch {
    hosts => ["${ELASTICSEARCH_CLUSTER_HOST}:${ELASTICSEARCH_CLUSTER_PORT}"]
    index => "${ELASTICSEARCH_INDEX_NAME}-%{+YYYY.MM}"
  }
  stdout {
    codec => rubydebug
  }
}

